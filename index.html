<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ã–ÄŸrenci Performans Takip Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f8f9fa; }
        .hidden { display: none !important; }
        .score-badge { font-size: 1.1em; font-weight: bold; }
        .log-list { max-height: 250px; overflow-y: auto; }
    </style>
</head>
<body>

    <div id="login-screen" class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-4">
                <div class="card p-4 shadow">
                    <h3 class="text-center mb-4">GiriÅŸ PortalÄ±</h3>
                    <input type="email" id="email" class="form-control mb-3" placeholder="E-posta Adresi">
                    <input type="password" id="password" class="form-control mb-3" placeholder="Åžifre">
                    <button onclick="girisYap()" class="btn btn-primary w-100">GiriÅŸ Yap</button>
                    <p id="login-error" class="text-danger mt-3 text-center small"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="app-screen" class="container mt-4 hidden">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 id="panel-title">ðŸ“š YÃ¶netim Paneli</h2>
            <div>
                <button id="rapor-btn" onclick="showReports()" class="btn btn-info me-2 hidden"><i class="bi bi-bar-chart-line"></i> Raporlar</button>
                <button onclick="cikisYap()" class="btn btn-outline-danger"><i class="bi bi-box-arrow-right"></i> Ã‡Ä±kÄ±ÅŸ</button>
            </div>
        </div>
        
        <div id="teacher-tools" class="hidden">
            <div class="card p-3 mb-3">
                <h5><i class="bi bi-person-plus"></i> Ã–ÄŸrenci Ekle</h5>
                <div class="input-group">
                    <input type="text" id="new-name" class="form-control" placeholder="Ad Soyad">
                    <input type="text" id="new-class" class="form-control" placeholder="SÄ±nÄ±f (Ã–rn: 9-A)">
                    <button onclick="ogrenciEkle()" class="btn btn-success">Ekle</button>
                </div>
            </div>
        </div>
        
        <div id="student-view">
            <div class="card p-3">
                <h5><i class="bi bi-people"></i> <span id="list-title">Ã–ÄŸrenci Listesi</span></h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>SÄ±nÄ±f</th>
                                <th>Ad Soyad</th>
                                <th>Toplam Puan</th>
                                <th id="action-header">Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody id="student-list-body">
                            </tbody>
                    </table>
                </div>
                <div id="parent-info" class="hidden">
                    <h5 class="mt-4"><i class="bi bi-clock-history"></i> Son DavranÄ±ÅŸ KayÄ±tlarÄ±</h5>
                    <ul id="parent-log-list" class="list-group log-list"></ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="scoreModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Puan GÃ¼ncelleme (<span id="modal-student-name"></span>)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
              <input type="hidden" id="modal-student-id">
              <input type="hidden" id="modal-current-score">
              <input type="number" id="point-input" class="form-control mb-3" placeholder="+ / - Puan MiktarÄ±">
              <textarea id="reason-input" class="form-control" placeholder="Neden (Ã–rn: Ã–devi TamamladÄ±, Derse KatÄ±lÄ±m Eksik)"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            <button type="button" onclick="puanKaydet()" class="btn btn-primary">Kaydet</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="reportModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Performans Raporu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
              <button onclick="raporUret('haftalik')" class="btn btn-warning me-2">HaftalÄ±k Rapor</button>
              <button onclick="raporUret('aylik')" class="btn btn-warning me-2">AylÄ±k Rapor</button>
              <hr>
              <div id="report-output"></div>
              <p class="small text-muted mt-3">Raporu yazdÄ±rabilmek iÃ§in tarayÄ±cÄ±nÄ±zÄ±n yazdÄ±rma Ã¶zelliÄŸini kullanÄ±n.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
          </div>
        </div>
      </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- 1. AYARLAR ---
        // BURAYI KENDÄ° FIREBASE CONFIG KODUNUZLA DEÄžÄ°ÅžTÄ°RMEYÄ° UNUTMAYIN
        const firebaseConfig = {
    apiKey: "AIzaSyDEHMG4QgACtomI_13PoFBBY0-fJe12SCo",
    authDomain: "ogrenci-performans-sistemi.firebaseapp.com",
    projectId: "ogrenci-performans-sistemi",
    storageBucket: "ogrenci-performans-sistemi.firebasestorage.app",
    messagingSenderId: "62800575318",
    appId: "1:62800575318:web:dd117d3157720e825034f7",
            // measurementId (Analytics kÄ±smÄ± Ã§Ä±karÄ±ldÄ±)
        };
        // ------------------

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUserRole = null; 
        let currentStudentId = null; 

        // --- GÄ°RÄ°Åž Ä°ÅžLEMLERÄ° ---
        function girisYap() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            document.getElementById('login-error').innerText = '';
            
            auth.signInWithEmailAndPassword(e, p)
                .catch((err) => {
                    // Hata 400 durumunda kullanÄ±cÄ±ya hata mesajÄ±nÄ± gÃ¶sterir
                    document.getElementById('login-error').innerText = "GiriÅŸ HatasÄ±: " + err.message;
                });
        }

        function cikisYap() {
            auth.signOut();
            currentUserRole = null;
            currentStudentId = null;
        }

        // Oturum Durum KontrolÃ¼ ve Rol Atama
        auth.onAuthStateChanged((user) => {
            if (user) {
                // GiriÅŸ baÅŸarÄ±lÄ±, ÅŸimdi rolÃ¼nÃ¼ kontrol et
                db.collection("users").doc(user.uid).get().then(doc => {
                    const userData = doc.data();
                    if (!userData || !userData.role) {
                        auth.signOut(); 
                        return alert("Hesap yetkilendirilmemiÅŸ. LÃ¼tfen Firestore'da 'users' koleksiyonunu kontrol edin.");
                    }
                    
                    currentUserRole = userData.role;
                    currentStudentId = userData.studentId || null; 
                    
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-screen').classList.remove('hidden');
                    
                    setupPanel(currentUserRole); 
                }).catch(error => {
                    auth.signOut();
                    alert("KullanÄ±cÄ± rolÃ¼ kontrol edilemedi: " + error.message);
                });

            } else {
                // Ã‡Ä±kÄ±ÅŸ yapÄ±lmÄ±ÅŸ veya oturum kapalÄ±
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });
        
        // Panele Ã¶zel ayarlamalar
        function setupPanel(role) {
            const isTeacher = role === 'teacher';
            document.getElementById('teacher-tools').classList.toggle('hidden', !isTeacher);
            document.getElementById('rapor-btn').classList.toggle('hidden', !isTeacher);
            document.getElementById('parent-info').classList.add('hidden'); 
            
            if (isTeacher) {
                document.getElementById('panel-title').innerText = 'ðŸ‘¨â€ðŸ« Ã–ÄŸretmen YÃ¶netim Paneli';
                document.getElementById('action-header').innerText = 'Ä°ÅŸlemler';
                document.getElementById('list-title').innerText = 'TÃ¼m Ã–ÄŸrenciler';
                verileriDinleTeacher(); 
            } else { // Veli
                document.getElementById('panel-title').innerText = 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§ Veli Bilgilendirme PortalÄ±';
                document.getElementById('action-header').innerText = 'Puan DetayÄ±';
                document.getElementById('list-title').innerText = 'Ã‡ocuÄŸunuzun PerformansÄ±';
                document.getElementById('parent-info').classList.remove('hidden');
                verileriDinleParent(); 
                loglariGosterParent(); 
            }
        }
        
        // --- Ã–ÄžRETMEN Ä°ÅžLEMLERÄ° ---
        
        function ogrenciEkle() {
            const ad = document.getElementById('new-name').value;
            const sinif = document.getElementById('new-class').value;
            if(!ad || !sinif) return alert("LÃ¼tfen Ad Soyad ve SÄ±nÄ±fÄ± doldurun.");

            db.collection("students").add({
                name: ad,
                className: sinif,
                score: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                document.getElementById('new-name').value = "";
                document.getElementById('new-class').value = "";
                alert("Ã–ÄŸrenci baÅŸarÄ±yla eklendi.");
            }).catch(error => {
                alert("Ã–ÄŸrenci eklenirken hata oluÅŸtu: " + error.message);
            });
        }

        function verileriDinleTeacher() {
             db.collection("students").orderBy("className").onSnapshot((snapshot) => {
                renderStudentList(snapshot);
            });
        }
        
        function openScoreModal(id, name, score) {
            document.getElementById('modal-student-id').value = id;
            document.getElementById('modal-student-name').innerText = name;
            document.getElementById('modal-current-score').value = score;
            document.getElementById('point-input').value = '';
            document.getElementById('reason-input').value = '';
            new bootstrap.Modal(document.getElementById('scoreModal')).show();
        }

        function puanKaydet() {
            const id = document.getElementById('modal-student-id').value;
            const puanStr = document.getElementById('point-input').value;
            const neden = document.getElementById('reason-input').value;
            
            if (!puanStr || !neden) return alert("Puan ve neden alanlarÄ± doldurulmalÄ±dÄ±r.");
            
            const puan = parseInt(puanStr);
            const mevcutPuan = parseInt(document.getElementById('modal-current-score').value);
            const yeniPuan = mevcutPuan + puan;
            
            // 1. Ã–ÄŸrencinin toplam puanÄ±nÄ± gÃ¼ncelle
            db.collection("students").doc(id).update({ score: yeniPuan });
            
            // 2. Log (GeÃ§miÅŸ) kaydÄ± ekle
            db.collection("logs").add({
                studentId: id,
                change: puan,
                reason: neden,
                date: firebase.firestore.FieldValue.serverTimestamp(),
                teacher: auth.currentUser.email
            }).then(() => {
                new bootstrap.Modal(document.getElementById('scoreModal')).hide();
            }).catch(error => {
                alert("Puan kaydedilirken hata oluÅŸtu: " + error.message);
            });
        }
        
        // --- VELÄ° Ä°ÅžLEMLERÄ° ---
        
        function verileriDinleParent() {
            if (!currentStudentId) return document.getElementById('student-list-body').innerHTML = '<tr><td colspan="4" class="text-center text-danger">HesabÄ±nÄ±z hiÃ§bir Ã¶ÄŸrenciye atanmamÄ±ÅŸ. LÃ¼tfen Ã¶ÄŸretmeninize baÅŸvurunuz.</td></tr>';
            
            db.collection("students").doc(currentStudentId).onSnapshot((doc) => {
                const liste = document.getElementById("student-list-body");
                liste.innerHTML = "";
                
                if (doc.exists) {
                    const data = doc.data();
                    const id = doc.id;
                    const renk = data.score >= 0 ? "text-success" : "text-danger";

                    const row = `
                        <tr>
                            <td><span class="badge bg-secondary">${data.className}</span></td>
                            <td>${data.name}</td>
                            <td class="${renk} score-badge">${data.score}</td>
                            <td><span class="text-muted small">Okuma EriÅŸimi</span></td>
                        </tr>
                    `;
                    liste.innerHTML += row;
                } else {
                    liste.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Ã–ÄŸrenci kaydÄ± bulunamadÄ±.</td></tr>';
                }
            });
        }
        
        function loglariGosterParent() {
             if (!currentStudentId) return;
             
             db.collection("logs")
                .where("studentId", "==", currentStudentId)
                .orderBy("date", "desc")
                .limit(10)
                .onSnapshot((snapshot) => {
                    const logList = document.getElementById("parent-log-list");
                    logList.innerHTML = "";
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const puan = data.change > 0 ? `+${data.change}` : data.change;
                        const renk = data.change > 0 ? "text-success" : "text-danger";
                        const tarih = data.date ? new Date(data.date.seconds * 1000).toLocaleDateString() : 'Bilinmiyor';
                        
                        const listItem = `
                            <li class="list-group-item d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fw-bold">${data.reason}</div>
                                    <span class="small text-muted">${tarih}</span>
                                </div>
                                <span class="badge bg-light rounded-pill ${renk}">${puan}</span>
                            </li>
                        `;
                        logList.innerHTML += listItem;
                    });
                     if (snapshot.empty) {
                        logList.innerHTML = '<li class="list-group-item text-center text-muted">HenÃ¼z davranÄ±ÅŸ kaydÄ± yok.</li>';
                    }
                });
        }


        // --- RAPORLAMA Ä°ÅžLEMLERÄ° (Ã–ÄŸretmen) ---
        
        function showReports() {
             new bootstrap.Modal(document.getElementById('reportModal')).show();
        }
        
        function raporUret(tip) {
            const output = document.getElementById('report-output');
            output.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div> Rapor hazÄ±rlanÄ±yor...</div>';

            const endDate = new Date();
            const startDate = new Date();
            
            if (tip === 'haftalik') {
                startDate.setDate(endDate.getDate() - 7);
            } else { // aylik
                startDate.setMonth(endDate.getMonth() - 1);
            }
            
            db.collection("logs").where("date", ">=", startDate).get().then(snapshot => {
                let studentSummary = {}; 
                let totalPositive = 0;
                let totalNegative = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = data.studentId;
                    
                    if (!studentSummary[id]) {
                        studentSummary[id] = { pos: 0, neg: 0, studentName: 'Bilinmiyor' };
                    }
                    
                    if (data.change > 0) {
                        studentSummary[id].pos += data.change;
                        totalPositive += data.change;
                    } else {
                        studentSummary[id].neg += data.change;
                        totalNegative += data.change;
                    }
                });
                
                const studentPromises = Object.keys(studentSummary).map(id => 
                    db.collection('students').doc(id).get().then(doc => {
                        if (doc.exists) {
                            studentSummary[id].studentName = doc.data().name + ' (' + doc.data().className + ')';
                        }
                    })
                );
                
                Promise.all(studentPromises).then(() => {
                    let html = `
                        <h6>${tip.toUpperCase()} PERFORMANS Ã–ZETÄ° (${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()})</h6>
                        <p class="small">Toplam Verilen Puan: <span class="text-success">${totalPositive}</span> Olumlu, <span class="text-danger">${totalNegative}</span> Olumsuz</p>
                        <table class="table table-striped table-sm" id="report-table">
                            <thead><tr><th>Ã–ÄŸrenci</th><th>Olumlu Puan</th><th>Olumsuz Puan</th><th>Net Puan</th></tr></thead>
                            <tbody>
                    `;
                    
                    for (const id in studentSummary) {
                        const summary = studentSummary[id];
                        const netPuan = summary.pos + summary.neg;
                        const renk = netPuan >= 0 ? "text-success" : "text-danger";

                        html += `
                            <tr>
                                <td>${summary.studentName}</td>
                                <td class="text-success">${summary.pos}</td>
                                <td class="text-danger">${summary.neg}</td>
                                <td class="${renk} fw-bold">${netPuan}</td>
                            </tr>
                        `;
                    }
                    
                    html += '</tbody></table>';
                    output.innerHTML = html;
                });
            }).catch(error => {
                output.innerHTML = '<p class="text-danger">Rapor oluÅŸturulurken hata oluÅŸtu: ' + error.message + '</p>';
            });
        }
        
        // --- ORTAK FONKSÄ°YONLAR ---
        
        function renderStudentList(snapshot) {
            const liste = document.getElementById("student-list-body");
            liste.innerHTML = "";
            const isTeacher = currentUserRole === 'teacher';

            snapshot.forEach((doc) => {
                const data = doc.data();
                const id = doc.id;
                
                let renk = data.score >= 0 ? "text-success" : "text-danger";

                const actions = isTeacher 
                    ? `<button onclick="openScoreModal('${id}', '${data.name}', ${data.score})" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil-square"></i> Puan Ver</button>`
                    : `<span class="text-muted small">Okuma EriÅŸimi</span>`;

                const row = `
                    <tr>
                        <td><span class="badge bg-secondary">${data.className}</span></td>
                        <td>${data.name}</td>
                        <td class="${renk} score-badge">${data.score}</td>
                        <td>${actions}</td>
                    </tr>
                `;
                liste.innerHTML += row;
            });
             if (snapshot.empty && isTeacher) {
                liste.innerHTML = '<tr><td colspan="4" class="text-center text-muted">HenÃ¼z Ã¶ÄŸrenci eklenmemiÅŸ.</td></tr>';
            }
        }
    </script>
</body>
</html>
